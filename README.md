# Семейный Мессенджер - Проект "Inner Circle"

## 📱 Обзор Проекта

**Inner Circle** - это простое, но функциональное приложение-мессенджер, созданное специально для внутрисемейного общения и использования в ограниченном кругу пользователей (5-10 человек). Проект разрабатывается как альтернатива популярным мессенджерам в условиях ограничений доступа к ним.

### 🎯 Целевая Аудитория
- **Основная:** Семья (5-10 человек)
- **Расширенная:** Может масштабироваться до нескольких сотен пользователей
- **Концепция:** Закрытое сообщество с регистрацией по приглашениям

### 🚀 Ключевые Принципы
- **Простота:** Максимально простой и понятный интерфейс
- **Безопасность:** Регистрация только по пригласительным кодам
- **Надежность:** Собственный сервер, полный контроль над данными
- **Производительность:** Быстрая работа в реальном времени

## 🎨 Функциональные Требования

### 📋 MVP (Минимально Жизнеспособный Продукт)

#### 1. **Система Аутентификации**
- ✅ Регистрация по пригласительным кодам
- ✅ Авторизация с помощью логина и пароля
- ✅ JWT-токены для безопасности сессий

#### 2. **Чаты и Сообщения**
- **Общий чат:** Один общий чат для всех участников семьи
- **Личные чаты:** Приватные чаты между двумя пользователями (1-на-1)
- **Обмен сообщениями:** Текстовые сообщения в реальном времени
- **История сообщений:** Сохранение и отображение истории переписки

#### 3. **Управление Пользователями**
- **Список пользователей:** Просмотр всех участников семьи
- **Создание чатов:** Возможность начать новый личный чат с любым пользователем
- **Статус пользователей:** Онлайн/оффлайн индикаторы

#### 4. **Голосовые Звонки**
- **Аудио-звонки:** Голосовые звонки между пользователями (без видео на первом этапе)
- **Уведомления о звонках:** Входящие и исходящие вызовы
- **Управление звонками:** Принять, отклонить, завершить

### 🔮 Будущие Возможности (Фаза 2+)
- Видеозвонки
- Отправка файлов и изображений
- Групповые чаты (кроме общего)
- Эмодзи и реакции
- Уведомления push

## 🛠 Технологический Стек

### **Frontend (Мобильное Приложение)**
- **Платформа:** Flutter (Dart)
- **Преимущества:** Кроссплатформенность (iOS + Android), высокая производительность UI
- **HTTP-клиент:** `dio` (v5.4.0)
- **WebSocket:** `socket_io_client` (v3.1.2)

### **Backend (Сервер)**
- **Основа:** Node.js с NestJS (TypeScript)
- **Real-time:** Socket.IO для обмена сообщениями в реальном времени
- **Архитектура:** Модульная архитектура NestJS
- **Аутентификация:** JWT + Passport.js
- **Валидация:** class-validator, class-transformer

### **База Данных**
- **СУБД:** PostgreSQL
- **ORM:** TypeORM
- **Особенности:** Автосинхронизация схемы в development-режиме

### **Связь в Реальном Времени**
- **WebRTC:** Для голосовых звонков (планируется)
- **Сигнализация:** Socket.IO сервер для WebRTC handshake

### **Развертывание**
- **Сервер:** Собственный сервер (без Docker)
- **База данных:** PostgreSQL на том же сервере
- **Мобильное приложение:** Прямая установка на устройства

## 📁 Структура Проекта

```
innercircle/
├── 📁 backend/                     # NestJS Backend приложение
│   ├── 📁 src/
│   │   ├── 📁 auth/               # Модуль аутентификации
│   │   │   ├── auth.controller.ts
│   │   │   ├── auth.service.ts
│   │   │   ├── auth.module.ts
│   │   │   ├── 📁 dto/
│   │   │   └── 📁 strategies/
│   │   ├── 📁 users/              # Модуль пользователей
│   │   │   ├── users.controller.ts
│   │   │   ├── users.service.ts
│   │   │   ├── users.module.ts
│   │   │   ├── 📁 dto/
│   │   │   └── 📁 entities/
│   │   ├── 📁 chat/               # Модуль чатов и сообщений
│   │   │   ├── chat.gateway.ts    # Socket.IO gateway
│   │   │   ├── chat.service.ts
│   │   │   ├── chat.module.ts
│   │   │   ├── 📁 dto/
│   │   │   ├── 📁 entities/
│   │   │   └── 📁 message/
│   │   ├── 📁 invitation-codes/   # Модуль пригласительных кодов
│   │   ├── app.module.ts          # Корневой модуль
│   │   └── main.ts               # Точка входа приложения
│   ├── .env                       # Переменные окружения
│   ├── package.json
│   └── tsconfig.json
├── 📁 frontend/                    # Flutter Mobile приложение
│   ├── 📁 lib/
│   │   ├── 📁 core/               # Основные сервисы
│   │   │   ├── 📁 api/           # HTTP клиент
│   │   │   └── 📁 socket/        # Socket.IO клиент
│   │   ├── 📁 features/          # Функциональные модули
│   │   │   ├── 📁 auth/          # Аутентификация
│   │   │   └── 📁 chat/          # Чаты и сообщения
│   │   └── main.dart             # Точка входа приложения
│   ├── pubspec.yaml              # Зависимости Flutter
│   └── 📁 assets/                # Ресурсы приложения
├── 📁 docs/                       # Документация проекта
│   ├── 📁 project_documentation/
│   │   └── structure.md          # Детальная структура проекта
│   ├── tasks.md                  # Задачи и статус разработки
│   └── technology_stack.md       # Технические детали стека
└── README.md                     # Этот файл (центральная документация)
```

## 🎯 Текущий Статус Разработки

### ✅ **Выполнено (MVP - Фаза 1)**
- [x] **Backend Setup:** NestJS приложение настроено и запущено
- [x] **Database:** PostgreSQL настроен и подключен
- [x] **Аутентификация:** Регистрация и авторизация работают
- [x] **Пригласительные коды:** Система приглашений реализована (временно один код)
- [x] **Flutter Setup:** Мобильное приложение инициализировано
- [x] **HTTP Integration:** Flutter подключен к backend API
- [x] **Socket.IO:** Real-time соединение настроено
- [x] **Базовые экраны:** Логин, регистрация, список чатов созданы
- [x] **Базовые сущности:** User, Chat, Message, InvitationCode
- [x] **CORS:** Настроено для взаимодействия frontend-backend
- [x] **Семейный чат:** Отображается в приложении (в процессе доработки)

### 🔄 **В Процессе**
- [x] **Создание чатов:** Семейный чат создается и отображается ✅
- [ ] **Полная работа семейного чата:** Доработка real-time сообщений
- [ ] **Список пользователей:** Экран со всеми участниками
- [ ] **Создание личных чатов:** Функционал создания 1-на-1 чатов
- [ ] **История сообщений:** Загрузка и отображение старых сообщений

### 📝 **Запланировано (Фаза 1)**
- [ ] **Улучшение системы приглашений:** Множественные коды (пока один код)
- [ ] **Улучшение UI:** Доработка пользовательского интерфейса
- [ ] **Обработка ошибок:** Корректная обработка сетевых ошибок
- [ ] **Валидация данных:** Улучшение валидации на frontend
- [ ] **Уведомления:** Базовые уведомления о новых сообщениях

### 🚀 **Будущие Фазы**
- [ ] **WebRTC Integration:** Голосовые звонки
- [ ] **Push Notifications:** Уведомления на устройства
- [ ] **File Sharing:** Отправка файлов и изображений
- [ ] **Deployment:** Развертывание на production сервер

## 🤖 Правила для ИИ-Агентов

### 📋 **Обязательные Правила**
1. **Остановка после задач:** После выполнения каждой задачи или подзадачи ОБЯЗАТЕЛЬНО остановиться и дождаться подтверждения от пользователя перед переходом к следующему шагу
2. **JSDoc документирование:** Все изменения в backend должны сопровождаться полной JSDoc документацией:
   ```typescript
   /**
    * Краткое описание функции
    * 
    * Подробное описание, особенности MVP, планы на будущее
    * 
    * @param paramName - Описание параметра с типом
    * @returns Описание возвращаемого значения
    * @throws {ErrorType} Условия выброса ошибки
    * @example
    * ```typescript
    * const result = await service.method('param');
    * ```
    * @since 1.0.0
    * @author ИИ-Ассистент + Bessonniy
    */
   ```
3. **Обновление структуры:** При создании новых файлов ОБЯЗАТЕЛЬНО обновлять `docs/project_documentation/structure.md`
4. **Параллельные инструменты:** Максимально использовать параллельные вызовы инструментов для ускорения работы
5. **Детальное логирование:** Объяснять каждое действие и его причину

### 🎯 **Приоритеты**
1. **Функциональность > Производительность:** Сначала работающий код, потом оптимизация
2. **Простота > Сложность:** Выбирать простые решения вместо сложных
3. **JSDoc документация:** Все backend классы, методы, entities должны быть документированы
4. **Тестирование:** После каждого изменения предлагать протестировать функционал

### 📝 **Стиль Кода**
- **TypeScript:** Строгая типизация, использование интерфейсов
- **JSDoc:** Обязательная документация всех Services, Controllers, Entities, DTO
- **Flutter:** Следование Flutter/Dart conventions
- **Комментарии:** Все сложные участки кода должны быть прокомментированы
- **Именование:** Понятные и описательные имена переменных и функций

## 🚀 Быстрый Старт для Разработки

### **Backend (NestJS)**

1. **Установка зависимостей:**
   ```bash
   cd backend
   npm install
   ```

2. **Настройка базы данных:**
   - Установить PostgreSQL
   - Создать базу данных `messenger_db`
   - Добавить пригласительный код `secret_invite` в таблицу `invitation_codes`:

   **Способ 1: Через pgAdmin (Рекомендуется)**
   1. Открыть pgAdmin 4
   2. Подключиться к PostgreSQL серверу
   3. Найти базу данных `messenger_db`
   4. Перейти: Schemas → public → Tables → invitation_codes
   5. ПКМ на таблице → View/Edit Data → All Rows
   6. Нажать `+` для добавления новой записи
   7. Заполнить поля:
      - `code`: `secret_invite`
      - `isUsed`: `false` (снять галочку)
      - Остальные поля оставить пустыми
   8. Сохранить (F6 или кнопка Save)

   **Способ 2: Через SQL команду (pgAdmin)**
   1. Открыть Query Tool в pgAdmin (кнопка SQL)
   2. Выполнить команду:
   ```sql
   INSERT INTO invitation_codes (code, "isUsed") 
   VALUES ('secret_invite', false);
   ```

   **Способ 3: Через psql (командная строка)**
   ```bash
   psql -U postgres -d messenger_db
   INSERT INTO invitation_codes (code, "isUsed") VALUES ('secret_invite', false);
   \q
   ```

   **⚠️ ВАЖНО:** После первого запуска backend автоматически создаст запись `secret_invite` если её нет!

3. **Настройка переменных окружения:**
   Создать файл `backend/.env`:
   ```env
   DATABASE_HOST=localhost
   DATABASE_PORT=5432
   DATABASE_USER=postgres
   DATABASE_PASSWORD=ваш_пароль
   DATABASE_NAME=messenger_db
   JWT_SECRET=супер_секретный_ключ
   ```

4. **Запуск сервера:**
   ```bash
   npm run start:dev
   ```

### **Frontend (Flutter)**

1. **Установка зависимостей:**
   ```bash
   cd frontend
   flutter pub get
   ```

2. **Запуск приложения:**
   ```bash
   flutter run
   ```

3. **Тестирование:**
   - Используйте код приглашения: `secret_invite` (единственный активный код)
   - Создайте аккаунт и протестируйте авторизацию

## 📚 Документация

### **Основные Документы**
- **[Технологический Стек](docs/technology_stack.md):** Подробная информация о выбранных технологиях
- **[Задачи Проекта](docs/tasks.md):** Детальный план разработки с прогрессом
- **[Структура Проекта](docs/project_documentation/structure.md):** Полная структура файлов и директорий

### **API Документация**
- **Аутентификация:**
  - `POST /auth/login` - Авторизация
  - `POST /users/register` - Регистрация (требует код: `secret_invite`)
  - `GET /users/profile` - Профиль пользователя

### **⚠️ Временные Ограничения (MVP)**
- **Пригласительные коды:** Используется только один код `secret_invite` для всех регистраций
- **Семейный чат:** Частично работает, требует доработки real-time функций
- **Список пользователей:** Пока не реализован
- **Личные чаты:** Пока не реализованы

## 🆘 Решение Проблем

### **Частые Проблемы**
1. **База данных не подключается:** Проверить PostgreSQL сервис и настройки в `.env`
2. **404 ошибки при регистрации:** Убедиться что backend запущен и доступен
3. **Пригласительный код не работает:** Добавить код в таблицу `invitation_codes`

### **Логи и Отладка**
- **Backend логи:** `npm run start:dev` в директории `backend/`
- **Flutter логи:** `flutter run` в директории `frontend/`
- **PostgreSQL логи:** Обычно в `data/log/` директории PostgreSQL

## 👨‍💻 Для Разработчиков

### **Архитектурные Принципы**
- **Модульность:** Каждая функция в отдельном модуле
- **Разделение ответственности:** Service для бизнес-логики, Controller для HTTP, Gateway для WebSocket
- **Типизация:** Строгая типизация TypeScript и Dart
- **Валидация:** Валидация данных на всех уровнях

### **База Данных**
```sql
-- Основные таблицы
- users (id, username, passwordHash, isAdmin, invitationCode, createdAt, updatedAt)
- invitation_codes (id, code, isUsed, usedByUserId, usedAt, createdAt, updatedAt)  
- chats (id, name, createdAt, updatedAt)
- messages (id, content, senderId, chatId, createdAt, updatedAt)
- chat_participants (связь many-to-many между users и chats)
```

## 🎯 Цель Документации

Этот README.md служит **единой точкой входа** для всех, кто работает с проектом:
- **ИИ-агенты:** Получают полный контекст для продолжения разработки
- **Разработчики:** Быстро понимают архитектуру и могут начать работу
- **Пользователи:** Понимают назначение и возможности приложения
- **Stakeholders:** Видят прогресс и планы разработки

---

**Статус последнего обновления:** Семейный чат отображается ✅ | Real-time требует доработки 🔄 | Звонки запланированы 📋

**Версия документации:** 1.1 | **Дата:** 16.08.2025 | **Автор:** ИИ-Ассистент + Bessonniy 